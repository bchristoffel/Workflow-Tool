<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AutonomyWorks Workflow (No Apps Script Calls)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* 
      ------------------------------------------------
      Global & Layout
      ------------------------------------------------
    */
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
    }

    /* 
      ------------------------------------------------
      LOADING OVERLAY for Start/Stop tasks (with spinner)
      ------------------------------------------------
    */
    #loadingOverlay {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      display: none; /* toggled on/off in code */
      align-items: center;
      justify-content: center;
      background-color: rgba(0,0,0,0.4);
      z-index: 9999; /* above everything else */
    }
    #loadingOverlay .loadingContent {
      background: white;
      padding: 30px 50px;
      border-radius: 8px;
      text-align: center;
      font-size: 18px;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .bigSpinner {
      width: 40px;
      height: 40px;
      border: 5px solid #f3f3f3; 
      border-top: 5px solid #333;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 
      ------------------------------------------------
      LOGIN OVERLAY 
      ------------------------------------------------
    */
    #loginOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(ellipse at center, rgba(20,30,60,0.15) 0%, rgba(20,40,70,0.8) 70%, rgba(20,40,70,1) 100%),
        url('https://images.unsplash.com/photo-1542744173-8e7e53415bb0?auto=format&fit=crop&w=1350&q=80')
          no-repeat center center fixed;
      background-size: cover;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000; 
    }
    .login-container {
      background: rgba(255,255,255,0.94);
      width: 360px;
      padding: 30px;
      border-radius: 14px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
      text-align: center;
    }
    .login-header {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #0d3b66;
      margin-bottom: 24px;
    }
    .login-header i {
      margin-left: 8px;
      font-size: 24px;
      color: #000;
    }
    input, button {
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 15px;
      font-family: 'Segoe UI', sans-serif;
    }
    input {
      border: 1px solid #ccc;
      transition: border 0.2s;
    }
    .input-error {
      border-color: red !important;
    }
    button {
      border: none;
      background: #b2ebf2;
      color: #00332d;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      background: #9adee6;
    }
    #loginSpinner {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    #loginSpinner .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin: 3px;
      background-color: #333;
      border-radius: 50%;
      animation: wave 1.2s infinite ease-in-out;
    }
    #loginSpinner .dot:nth-child(1){ animation-delay: 0s; }
    #loginSpinner .dot:nth-child(2){ animation-delay: 0.12s; }
    #loginSpinner .dot:nth-child(3){ animation-delay: 0.24s; }
    @keyframes wave {
      0%,60%,100%{ transform:translateY(0); }
      30%{ transform:translateY(-8px); }
    }

    /* 
      ------------------------------------------------
      MAIN TASK SCREEN 
      ------------------------------------------------
    */
    #taskScreen {
      display: none; 
      width: 100%; 
      height: 100%;
      background-color: #f0f0f0;
      padding: 20px;
      position: relative;
      overflow: auto;
      z-index: 1; /* behind the loading overlay if shown */
    }
    #notificationBar {
      display: none;
      width: 100%;
      text-align: center;
      font-weight: 600;
      padding: 8px 0;
      margin-bottom: 10px;
    }
    #greeting {
      text-align: center;
      margin: 0 auto 20px;
      font-size: 22px;
      color: #1d3330;
    }

    /* 
      ------------------------------------------------
      Start Task button (short/wide)
      ------------------------------------------------
    */
    #startTaskBtn {
      width: 240px;
      height: 45px;
      font-size: 16px;
    }
    .spinner-wheel {
      display: none;
      margin: 10px auto;
      width: 30px;
      height: 30px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #333;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* 
      ------------------------------------------------
      Task details area (2 columns, responsive)
      ------------------------------------------------
    */
    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 600px) {
      .details-grid {
        grid-template-columns: 1fr;
      }
    }

    /*
      ------------------------------------------------
      STOP TASK: statuses, notes, button
      ------------------------------------------------
    */
    #statusOptions {
      display: none;
      margin: 20px auto;
      max-width: 800px;
      text-align: center;
    }
    .status-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    #notes {
      display: none;
      width: 80%;
      height: 50px;
      margin-top: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      font-size: 14px;
      font-family: 'Segoe UI', sans-serif;
      transition: border 0.2s;
    }
    .stop-task-container {
      margin-top: 20px;
    }
    .stop-btn {
      width: 150px;
      height: 40px;
      font-size: 15px;
      font-weight: 600;
      background: #b2ebf2;
      color: #00332d;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    .stop-btn:hover {
      background: #9adee6;
    }
    #stopSpinner {
      display: none;
      margin: 10px auto;
      width: 30px;
      height: 30px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #333;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* 
      ------------------------------------------------
      ON CALL MODAL 
      ------------------------------------------------
    */
    #onCallModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
      text-align: center;
      width: 600px;
      max-width: 90vw;
      font-family: 'Segoe UI', sans-serif;
      z-index: 2000;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: none;
    }

    /* 
      ------------------------------------------------
      Logout link 
      (bottom, centered)
      ------------------------------------------------
    */
    .logout-link {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: #00332d;
      text-decoration: underline;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      background: #f0f0f0;
      padding: 5px 10px;
      border-radius: 4px;
    }
    .logout-link:hover {
      color: #00796b;
    }
  </style>
</head>
<body>

<!-- LOADING OVERLAY (spinner) -->
<div id="loadingOverlay">
  <div class="loadingContent">
    <div class="bigSpinner"></div>
    <div>Loading, please wait...</div>
  </div>
</div>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
  <div class="login-container">
    <div class="login-header">
      AutonomyWorks <i class="fa-solid fa-briefcase"></i>
    </div>
    <input id="username" placeholder="Username" onkeydown="checkEnter(event)">
    <input id="password" type="password" placeholder="Password" onkeydown="checkEnter(event)">
    <button onclick="login()">Login</button>
    <div id="loginSpinner">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>
</div>

<!-- MAIN TASK SCREEN -->
<div id="taskScreen">
  <div id="notificationBar"></div>
  <h2 id="greeting"></h2>

  <!-- Start Task / Refresh area -->
  <div style="text-align:center;">
    <button id="startTaskBtn" onclick="startTaskClicked()">Start Task</button>
    <div id="startSpinner" class="spinner-wheel"></div>
  </div>

  <!-- Task details area -->
  <div id="taskDetail" style="margin-top:20px;"></div>

  <!-- STOP TASK container: statuses + notes + button -->
  <div id="statusOptions">
    <div class="status-container">
      <label>
        <input type="radio" name="stopStatus" value="In Progress" onchange="statusChosen()">
        In Progress<span style="color:red;">*</span>
      </label>
      <label>
        <input type="radio" name="stopStatus" value="Issue" onchange="statusChosen()">
        Issue<span style="color:red;">*</span>
      </label>
      <label>
        <input type="radio" name="stopStatus" value="Completed" onchange="statusChosen()">
        Completed
      </label>
    </div>

    <textarea
      id="notes"
      placeholder="Associate Notes">
    </textarea>

    <div class="stop-task-container">
      <button class="stop-btn" onclick="stopTask()">Stop Task</button>
      <div id="stopSpinner"></div>
    </div>
  </div>

  <span class="logout-link" onclick="logout()">Log Out</span>
</div>

<!-- ON CALL MODAL -->
<div id="onCallModal">
  <h3>
    On Call: Please refresh every five minutes. 
    If you are still On Call after 15 minutes, please reach out to your Lead.
  </h3>
  <iframe src="https://chromedino.com/" allowfullscreen></iframe>
  <p style="line-height:1.4;">
    You can close this game or hit “Refresh” to check for tasks again.
  </p>
  <button onclick="closeOnCall()" style="margin-top:10px;">Close Game</button>
</div>

<script>
/*
  ============================
  CONFIG / GLOBALS
  ============================
  Replacing old SheetDB links with 5 Worker endpoints:
  1) /backend
  2) /taskData
  3) /taskHistory
  4) /lasallePod
  5) /questionAssociates
*/
const BACKEND_URL           = "https://my-api.bchristoffel02.workers.dev/backend";
const TASK_DATA_URL         = "https://my-api.bchristoffel02.workers.dev/taskData";
const TASK_HISTORY_URL      = "https://my-api.bchristoffel02.workers.dev/taskHistory";
const LASALLE_POD_URL       = "https://my-api.bchristoffel02.workers.dev/lasallePod";
const QUESTION_ASSOC_URL    = "https://my-api.bchristoffel02.workers.dev/questionAssociates";

/* 
  Hardcoded password for demonstration.
  If you need real auth, you'd implement a secure backend check.
*/
const HARDCODED_PASS   = "abc123";

let userFullName = "";
let tasks        = [];
let currentTask  = null;
let startTime    = null;


/* ============================
   HELPER / UTILITY
   ============================ */

/** 
 * Set a notification message in #notificationBar,
 * with an optional isError boolean for red text. 
 */
function setNotification(msg, isError=false) {
  const bar = document.getElementById("notificationBar");
  if(!msg) {
    bar.style.display="none";
    bar.innerText = "";
    return;
  }
  bar.style.display="block";
  bar.style.color=isError?"red":"#0f5132";
  bar.innerText=msg;
}

/** 
 * Add or remove the .input-error class from an input 
 */
function highlightInput(id, shouldHighlight){
  const el=document.getElementById(id);
  if(!el)return;
  if(shouldHighlight)el.classList.add("input-error");
  else el.classList.remove("input-error");
}

/** 
 * Show or hide the big loading overlay 
 */
function showLoading(show) {
  document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
}

/** 
 * Format Date => "MM/DD/YYYY HH:MM:SS" 
 */
function formatDateTime(d) {
  if(!(d instanceof Date))return"";
  const pad=n=>(n<10?"0"+n:""+n);
  const mm=pad(d.getMonth()+1), dd=pad(d.getDate()), yy=d.getFullYear();
  const hh=pad(d.getHours()), mn=pad(d.getMinutes()), sc=pad(d.getSeconds());
  return `${mm}/${dd}/${yy} ${hh}:${mn}:${sc}`;
}

/** 
 * Return "H:MM:SS" difference between two Date objects 
 */
function computeCumulativeTime(st,sp){
  if(!st||!sp)return"";
  const diff=sp-st, sec=Math.floor(diff/1000);
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  const pad=n=>(n<10?"0"+n:n);
  return `${h}:${pad(m)}:${pad(s)}`;
}

/** 
 * Insert a single new row to the given URL with the rowObj data.
 */
async function insertRow(url, rowObj) {
  const resp = await fetch(url, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ data:[ rowObj ] })
  });
  if(!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
}

/** 
 * Attempt to find the "Direct Questions To:" contact from the 
 * "Question Associates" tab (QUESTION_ASSOC_URL),
 * matching the "Client:" name as a lookup key.
 */
async function findDirectQuestion(clientName){
  if(!clientName)return"";
  try {
    const r=await fetch(QUESTION_ASSOC_URL);
    const j=await r.json();
    if(!j.values || !Array.isArray(j.values)) return "";
    const headers = j.values[0] || [];
    const dataRows = j.values.slice(1);
    const cIdx = headers.indexOf("Client");
    const pIdx = headers.indexOf("Primary Contact");
    const sIdx = headers.indexOf("Secondary Contact");
    const bIdx = headers.indexOf("Backup Contact");
    if(cIdx<0) return "";

    const row = dataRows.find(rr => (rr[cIdx]||"").trim().toLowerCase() === clientName.toLowerCase());
    if(!row)return"";
    return row[pIdx] || row[sIdx] || row[bIdx] || "";
  } catch(e){
    console.error("Error findDirectQuestion =>", e);
    return "";
  }
}

/** 
 * Reset the screen after stopping or logging out:
 * - Hide #statusOptions
 * - Clear #notes and hide it
 * - Clear currentTask, startTime
 * - Clear #taskDetail content
 */
function resetScreen(){
  document.getElementById("statusOptions").style.display="none";
  const note=document.getElementById("notes");
  note.value="";
  note.style.display="none";
  currentTask=null;
  startTime=null;
  document.getElementById("taskDetail").innerHTML="";
}

/** 
 * Show the #notes area once a radio status is chosen.
 */
function statusChosen(){
  document.getElementById("notes").style.display="block";
}


/* ============================
   AUTH / LOGIN 
   ============================ */

/** 
 * If user hits Enter in the username/password field, call login()
 */
function checkEnter(e){
  if(e.key==="Enter") login();
}

/** 
 * Validate user input, fetch from LASALLE_POD_URL to confirm user exists, 
 * then show #taskScreen if valid.
 */
async function login(){
  setNotification("");
  const user = document.getElementById("username").value.trim().toLowerCase();
  const pass = document.getElementById("password").value.trim();
  highlightInput("username", !user);
  highlightInput("password", !pass);

  if(!user || !pass){
    setNotification("Username and Password are required.",true);
    return;
  }
  if(pass !== HARDCODED_PASS){
    setNotification("Invalid login credentials.",true);
    return;
  }

  const spin=document.getElementById("loginSpinner");
  spin.style.display="block";
  try {
    const r=await fetch(LASALLE_POD_URL);
    const j=await r.json();
    spin.style.display="none";

    if(!j.values || !Array.isArray(j.values)){
      setNotification("LaSalle Pod data not found or invalid structure.",true);
      return;
    }
    const headers = j.values[0] || [];
    const dataRows = j.values.slice(1);
    const uIdx = headers.indexOf("Username");
    const fnIdx= headers.indexOf("First Name");
    const lnIdx= headers.indexOf("Last Name");
    if(uIdx<0 || fnIdx<0 || lnIdx<0){
      setNotification("Missing columns in 'LaSalle Pod' tab.",true);
      return;
    }

    // find the row with matching "Username"
    const row = dataRows.find(r => (r[uIdx]||"").trim().toLowerCase()===user);
    if(!row){
      setNotification("User not found in LaSalle Pod data.",true);
      return;
    }
    const fn=(row[fnIdx]||"").trim();
    const ln=(row[lnIdx]||"").trim();
    userFullName = fn + " " + ln;

    document.getElementById("greeting").textContent="Hello, "+userFullName+"!";
    document.getElementById("loginOverlay").style.display="none";
    document.getElementById("taskScreen").style.display="block";
  } catch(e){
    spin.style.display="none";
    if(e instanceof TypeError){
      setNotification("Network error - check your connection.",true);
    } else {
      setNotification("Error => "+e.message,true);
    }
  }
}


/* ============================
   START TASK / REFRESH
   ============================ */

/** 
 * Called when user clicks "Start Task" or "Refresh". 
 * Show spinner, fetch ready tasks, etc.
 */
function startTaskClicked(){
  setNotification("");
  document.getElementById("startTaskBtn").style.display="none";
  document.getElementById("startSpinner").style.display="block";
  showLoading(true);
  loadReadyTasks();
}

/** 
 * Fetch tasks from the BACKEND_URL, parse row data,
 * filter for (Associate=user, Status=Ready).
 * If none => on-call. If found => insert row (status=Started).
 */
async function loadReadyTasks(){
  try {
    const r=await fetch(BACKEND_URL);
    const data=await r.json();
    if(!data.values) throw new Error("No values array in 'Backend' data");
    const headers=data.values[0];
    const rows=data.values.slice(1);

    const assocIdx = headers.indexOf("Associate:");
    const statusIdx= headers.indexOf("Status:");
    if(assocIdx<0 || statusIdx<0){
      throw new Error("Missing columns in 'Backend' tab. Must have 'Associate:' and 'Status:' headers.");
    }

    tasks = rows.filter(row=>{
      const assoc=(row[assocIdx]||"").trim().toLowerCase();
      const stat =(row[statusIdx]||"").trim().toLowerCase();
      return assoc===userFullName.toLowerCase() && stat==="ready";
    }).map(r=>convertRowToObj(r, headers));

    document.getElementById("startSpinner").style.display="none";
    showLoading(false);

    if(!tasks.length){
      setNotification("You are on call. No tasks found.");
      const btn=document.getElementById("startTaskBtn");
      btn.style.display="inline-block";
      btn.innerText="Refresh";
      document.getElementById("onCallModal").style.display="block";
      setTimeout(()=>setNotification("Reminder: Please refresh every 5 mins."),300000);
      return;
    }

    // We have at least 1 "Ready" task
    currentTask=tasks[0];
    document.getElementById("onCallModal").style.display="none";
    document.getElementById("startTaskBtn").style.display="none";

    const startNow=new Date();
    startTime=startNow;
    const startStr=formatDateTime(startNow);

    // Insert row => "Started" in Backend
    const newRowObj={
      ...currentTask,
      "Status:":"Started",
      "Time:":"Start: "+startStr
    };
    await insertRow(BACKEND_URL, newRowObj);

    // Insert row => "Started" in Task Data & Task History
    const rowObj2 = {
      ...currentTask,
      "Status:":"Started",
      "Start Time:":startStr,
      "Stop Time":"",
      "Cumulative Time":"",
      "Associate Notes":"",
      "Update":"FALSE"
    };
    await insertRow(TASK_DATA_URL, rowObj2);
    await insertRow(TASK_HISTORY_URL, rowObj2);

    // Show details
    displayTaskDetails(currentTask);
    document.getElementById("statusOptions").style.display="block";

  }catch(e){
    showLoading(false);
    document.getElementById("startSpinner").style.display="none";
    document.getElementById("startTaskBtn").style.display="inline-block";
    setNotification("Error loading tasks => "+e.message,true);
  }
}

/** 
 * Convert row array => object using the given headers
 */
function convertRowToObj(rowArr, headers){
  const obj={};
  headers.forEach((hdr, idx)=>{
    obj[hdr]=rowArr[idx]||"";
  });
  return obj;
}

/** 
 * Display the details (client, param1, param2, etc.) in a 2-col grid.
 */
async function displayTaskDetails(task){
  if(!task){
    document.getElementById("taskDetail").innerHTML="<p>No tasks to display.</p>";
    return;
  }
  const clientName=(task["Client:"]||"").trim();
  const qAssoc=await findDirectQuestion(clientName);

  const html=`
    <div class="details-grid">
      <div><b>Client:</b> ${(task["Client:"]||"")}</div>
      <div><b>Parameter 1:</b> ${(task["Parameter 1:"]||"")}</div>
      <div><b>Task:</b> ${(task["Task:"]||"")}</div>
      <div><b>Parameter 2:</b> ${(task["Parameter 2:"]||"")}</div>
      <div><b>Deliverable Name:</b> ${(task["Deliverable Name:"]||"")}</div>
      <div><b>Production Notes:</b> ${(task["Production Notes:"]||"")}</div>
      <div><b>Direct Questions To:</b> ${qAssoc||""}</div>
      <div><b>Due Time:</b> ${(task["Due Time:"]||"")}</div>
    </div>
  `;
  document.getElementById("taskDetail").innerHTML=html;
}


/* ============================
   STOP TASK
   ============================ */
async function stopTask(){
  setNotification("");
  document.getElementById("stopSpinner").style.display="block";
  document.querySelector(".stop-btn").style.display="none";
  showLoading(true);

  if(!currentTask){
    setNotification("No current task to stop.",true);
    endStopSpinner();
    return;
  }

  // Which status radio?
  let chosen="";
  const rads=document.getElementsByName("stopStatus");
  for(let i=0;i<rads.length;i++){
    if(rads[i].checked){
      chosen=rads[i].value;
      break;
    }
  }
  if(!chosen){
    setNotification("Please select a status first.",true);
    endStopSpinner();
    return;
  }
  // If "In Progress" or "Issue", notes are required
  const noteEl=document.getElementById("notes");
  const noteVal=noteEl.value.trim();
  const requiresNote=(chosen==="In Progress"||chosen==="Issue");
  highlightInput("notes",requiresNote&&!noteVal);
  if(requiresNote&&!noteVal){
    setNotification(`Notes are required for status: ${chosen}`,true);
    endStopSpinner();
    return;
  }

  try{
    const stopNow=new Date();
    const stopStr=formatDateTime(stopNow);
    const combined=`Start: ${formatDateTime(startTime)||"?"} | Stop: ${stopStr}`;

    // Insert row => "Stopped" in Backend
    const newRowObj={
      ...currentTask,
      "Status:": chosen,
      "Time:": combined
    };
    await insertRow(BACKEND_URL, newRowObj);

    // Insert row => "Stopped" in Task Data + Task History
    const cTime=(startTime&&stopNow)?computeCumulativeTime(startTime,stopNow):"";
    const rowObj2={
      ...currentTask,
      "Status:": chosen,
      "Start Time:": formatDateTime(startTime)||"",
      "Stop Time:": stopStr,
      "Cumulative Time:": cTime,
      "Associate Notes:": noteVal,
      "Update":"FALSE"
    };
    await insertRow(TASK_DATA_URL, rowObj2);
    await insertRow(TASK_HISTORY_URL, rowObj2);

  } catch(e){
    setNotification("Error stopping task => "+e.message,true);
  } finally {
    resetScreen();
    endStopSpinner();
    document.getElementById("startTaskBtn").style.display="inline-block";
    document.getElementById("startTaskBtn").innerText="Start Task";
  }
}

function endStopSpinner(){
  document.getElementById("stopSpinner").style.display="none";
  document.querySelector(".stop-btn").style.display="inline-block";
  showLoading(false);
}


/* ============================
   ON CALL / LOGOUT
   ============================ */
function closeOnCall(){
  document.getElementById("onCallModal").style.display="none";
}

function logout(){
  setNotification("");
  resetScreen();
  userFullName="";
  document.getElementById("taskScreen").style.display="none";
  document.getElementById("loginOverlay").style.display="flex";
  document.getElementById("username").value="";
  document.getElementById("password").value="";
}
</script>
</body>
</html>
