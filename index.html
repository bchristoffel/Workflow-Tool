<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AutonomyWorks Workflow - Full Final Version</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- 
       ---------------------------------------------------------------------------
       This single-file front-end HTML merges all requested features:
         1) Hardcoded login with "abc123"
         2) 18-column insertion for Task Data/History
         3) Partial updates to "Backend" columns:
             B => Start Time
             C => Stop Time
             F => Status
             P => Associate Notes
         4) On Call modal, loading overlay, unselecting radios, etc.
         5) Centered greeting, center #notes box
         6) ~800 lines of code for clarity
       ---------------------------------------------------------------------------
  -->

  <style>
/*********************************************************************
 * GLOBAL & RESET
 *********************************************************************/
* {
  box-sizing: border-box;
  /* ensures that width/height calculations consider padding/border */
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: 'Segoe UI', sans-serif;
  /* The UI font requested */
}

/*********************************************************************
 * LOADING OVERLAY
 *********************************************************************/

#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: none; /* toggled in code with showLoading(true/false) */
  align-items: center;
  justify-content: center;
  background-color: rgba(0,0,0,0.4);
  z-index: 9999; /* on top of everything else */
}

#loadingOverlay .loadingContent {
  background: white;
  padding: 30px 50px;
  border-radius: 8px;
  text-align: center;
  font-size: 18px;
  color: #333;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.bigSpinner {
  width: 40px;
  height: 40px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid #333;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
  margin-bottom: 15px;
}
@keyframes spin {
  0%   { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/*********************************************************************
 * LOGIN OVERLAY
 *********************************************************************/
#loginOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;

  /* background gradient + image, covering everything */
  background:
    radial-gradient(ellipse at center, rgba(20,30,60,0.15) 0%, rgba(20,40,70,0.8) 70%, rgba(20,40,70,1) 100%),
    url('https://images.unsplash.com/photo-1542744173-8e7e53415bb0?auto=format&fit=crop&w=1350&q=80')
      no-repeat center center fixed;
  background-size: cover;

  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.login-container {
  background: rgba(255,255,255,0.94);
  width: 360px;
  padding: 30px;
  border-radius: 14px;
  box-shadow: 0 10px 28px rgba(0,0,0,0.25);
  text-align: center;
}

.login-header {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: #0d3b66;
  margin-bottom: 24px;
}

input, button {
  width: 100%;
  padding: 10px;
  border-radius: 4px;
  margin-top: 10px;
  font-size: 15px;
  font-family: 'Segoe UI', sans-serif;
}

input {
  border: 1px solid #ccc;
  transition: border 0.2s;
}

.input-error {
  border-color: red !important;
}

button {
  border: none;
  background: #b2ebf2;
  color: #00332d;
  font-weight: 600;
  cursor: pointer;
}
button:hover {
  background: #9adee6;
}

#loginSpinner {
  display: none;
  text-align: center;
  margin-top: 20px;
}

#loginSpinner .dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  margin: 3px;
  background-color: #333;
  border-radius: 50%;
  animation: wave 1.2s infinite ease-in-out;
}
#loginSpinner .dot:nth-child(1) { animation-delay: 0s;   }
#loginSpinner .dot:nth-child(2) { animation-delay: 0.12s;}
#loginSpinner .dot:nth-child(3) { animation-delay: 0.24s;}

@keyframes wave {
  0%, 60%, 100% { transform:translateY(0);}
  30% { transform:translateY(-8px);}
}

/*********************************************************************
 * MAIN TASK SCREEN
 *********************************************************************/
#taskScreen {
  display: none; 
  width: 100%; 
  height: 100%;
  background-color: #f0f0f0;
  padding: 20px;
  position: relative;
  overflow: auto;
  z-index: 1;
}
#notificationBar {
  display: none;
  width: 100%;
  text-align: center;
  font-weight: 600;
  padding: 8px 0;
  margin-bottom: 10px;
  /* We'll set color in code if needed */
}

#greeting {
  text-align: center;
  margin: 0 auto 20px;
  font-size: 22px;
  color: #1d3330;
}

/*********************************************************************
 * START TASK button
 *********************************************************************/
#startTaskBtn {
  width: 240px;
  height: 45px;
  font-size: 16px;
  display: inline-block;
  margin: 0 auto; /* doesn't center if not in a block container, but we handle it anyway */
  /* We'll place greeting + start in a container below if needed */
}

/*********************************************************************
 * Center Container for Greeting + Start Task
 *********************************************************************/
#centerContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 20px auto;
}

/*********************************************************************
 * Task details area (2 columns, responsive)
 *********************************************************************/
.details-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  max-width: 800px;
  margin: 0 auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
@media (max-width: 600px) {
  .details-grid {
    grid-template-columns: 1fr;
  }
}

/*********************************************************************
 * STOP TASK container: statuses + notes + button
 *********************************************************************/
#statusOptions {
  display: none;
  margin: 20px auto;
  max-width: 800px;
  text-align: center;
}

.status-container {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
}

#notes {
  display: none;
  width: 80%;
  margin: 0 auto; /* center horizontally */
  height: 50px;
  margin-top: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 8px;
  font-size: 14px;
  font-family: 'Segoe UI', sans-serif;
  transition: border 0.2s;
}

.stop-task-container {
  margin-top: 20px;
}

.stop-btn {
  width: 150px;
  height: 40px;
  font-size: 15px;
  font-weight: 600;
  background: #b2ebf2;
  color: #00332d;
  cursor: pointer;
  border: none;
  border-radius: 4px;
}
.stop-btn:hover {
  background: #9adee6;
}

#stopSpinner {
  display: none;
  margin: 10px auto;
  width: 30px;
  height: 30px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #333;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/*********************************************************************
 * ON CALL MODAL
 *********************************************************************/
#onCallModal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 10px 28px rgba(0,0,0,0.25);
  text-align: center;
  width: 600px;
  max-width: 90vw;
  font-family: 'Segoe UI', sans-serif;
  z-index: 2000;
}
iframe {
  width: 100%;
  height: 400px;
  border: none;
}

/*********************************************************************
 * LOGOUT link (bottom, centered)
 *********************************************************************/
.logout-link {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  color: #00332d;
  text-decoration: underline;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  background: #f0f0f0;
  padding: 5px 10px;
  border-radius: 4px;
}
.logout-link:hover {
  color: #00796b;
}

/*********************************************************************
 * END OF CSS
 *********************************************************************/
  </style>
</head>

<body>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay">
  <div class="loadingContent">
    <div class="bigSpinner"></div>
    <div>Loading, please wait...</div>
  </div>
</div>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
  <div class="login-container">
    <div class="login-header">
      AutonomyWorks <i class="fa-solid fa-briefcase"></i>
    </div>
    <input id="username" placeholder="Username" onkeydown="checkEnter(event)">
    <input id="password" type="password" placeholder="Password" onkeydown="checkEnter(event)">
    <button onclick="login()">Login</button>
    <div id="loginSpinner">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>
</div>

<!-- MAIN TASK SCREEN -->
<div id="taskScreen">
  <div id="notificationBar"></div>

  <!-- Container for Greeting + Start Task, centered -->
  <div id="centerContainer">
    <h2 id="greeting"></h2>
    <button id="startTaskBtn" onclick="startTaskClicked()">Start Task</button>
  </div>

  <!-- Task details area -->
  <div id="taskDetail" style="margin-top:20px;"></div>

  <!-- STOP TASK container -->
  <div id="statusOptions">
    <div class="status-container">
      <label>
        <input type="radio" name="stopStatus" value="In Progress" onchange="statusChosen()">
        In Progress<span style="color:red;">*</span>
      </label>
      <label>
        <input type="radio" name="stopStatus" value="Issue" onchange="statusChosen()">
        Issue<span style="color:red;">*</span>
      </label>
      <label>
        <input type="radio" name="stopStatus" value="Completed" onchange="statusChosen()">
        Completed
      </label>
    </div>

    <textarea
      id="notes"
      placeholder="Associate Notes">
    </textarea>

    <div class="stop-task-container">
      <button class="stop-btn" onclick="stopTask()">Stop Task</button>
      <div id="stopSpinner"></div>
    </div>
  </div>

  <span class="logout-link" onclick="logout()">Log Out</span>
</div>

<!-- ON CALL MODAL -->
<div id="onCallModal">
  <h3>
    On Call: Please refresh every five minutes. 
    If you are still On Call after 15 minutes, please reach out to your Lead.
  </h3>
  <iframe src="https://chromedino.com/" allowfullscreen></iframe>
  <p style="line-height:1.4;">
    You can close this game or hit “Refresh” to check for tasks again.
  </p>
  <button onclick="closeOnCall()" style="margin-top:10px;">Close Game</button>
</div>

<script>
/******************************************************************************
 * 
 * FULL FRONT-END SCRIPT
 * ~ 800 lines total.
 * 
 * This script merges all updates:
 *  - Hardcoded password: "abc123"
 *  - 18-column insertion into Task Data & Task History
 *  - Partial updates to "Backend" columns:
 *      B => Start Time
 *      C => Stop Time
 *      F => Status
 *      P => Associate Notes
 *  - On Call modal, loading overlay, unselecting stop-task radios, etc.
 *  - Additional comments for clarity and thoroughness.
 * 
 *****************************************************************************/

/******************************************************************************
 * 1) CONFIG / GLOBALS
 ******************************************************************************
 * We'll define constants for your Worker domain. 
 * We'll also define the 18 columns we post to Task Data and Task History.
 *****************************************************************************/

const WORKER_DOMAIN = "https://my-api.bchristoffel02.workers.dev";  // your domain
// partial update route => "Backend!ColumnLetter{rowNumber}"
const UPDATE_BACKEND_CELL_URL = WORKER_DOMAIN + "/updateBackendCell";
const BACKEND_URL        = WORKER_DOMAIN + "/backend";
const TASK_DATA_URL      = WORKER_DOMAIN + "/taskData";
const TASK_HISTORY_URL   = WORKER_DOMAIN + "/taskHistory";
const LASALLE_POD_URL    = WORKER_DOMAIN + "/lasallePod";
const QUESTION_ASSOC_URL = WORKER_DOMAIN + "/questionAssociates";

// Hardcoded password for demonstration
const HARDCODED_PASS = "abc123";

// For partial updates, "Backend" columns:
const COL_START_TIME = "B"; // Start Time => Column B
const COL_STOP_TIME  = "C"; // Stop Time => Column C
const COL_STATUS     = "F"; // Status => Column F
const COL_NOTES      = "P"; // Associate Notes => Column P

// We'll store the rowNumber from the "Backend" so we can do partial updates
let userFullName     = "";
let currentTask      = null;
let startTime        = null; // Date object
let currentRowNumber = null; // integer row (2-based index in the sheet, row 1 is headers)


// For the 18 columns in Task Data/History, we have indexes like this:
// 0 => Update:
// 1 => Start Time:
// 2 => Stop Time:
// 3 => Priority:
// 4 => Associate:
// 5 => Status:
// 6 => Client:
// 7 => Task:
// 8 => Deliverable Name:
// 9 => Deliverable ID:
// 10 => Parameter 1:
// 11 => Parameter 2:
// 12 => Production Notes:
// 13 => Due Time:
// 14 => Due Date:
// 15 => Associate Notes:
// 16 => Job Code:
// 17 => Cumulative Time:


/******************************************************************************
 * 2) HELPER / UTILITY
 ******************************************************************************
 * We'll define some helper functions for showing loading overlays,
 * partial updates, etc.
 *****************************************************************************/

/** 
 * Show/hide #notificationBar with optional error styling 
 */
function setNotification(msg, isError=false) {
  const bar = document.getElementById("notificationBar");
  if(!msg) {
    bar.style.display = "none";
    bar.innerText="";
    return;
  }
  bar.style.display="block";
  bar.style.color=isError?"red":"#0f5132";
  bar.innerText=msg;
}

/** 
 * If user hits Enter in the login fields => login 
 */
function checkEnter(e) {
  if(e.key==="Enter") login();
}

/** 
 * Show or hide the big #loadingOverlay
 */
function showLoading(show) {
  document.getElementById("loadingOverlay").style.display = show?"flex":"none";
}

/** 
 * Format Date => "MM/DD/YYYY HH:MM:SS" 
 */
function formatDateTime(d) {
  if(!(d instanceof Date))return"";
  const pad=n=>(n<10?"0"+n:""+n);
  const mm=pad(d.getMonth()+1), dd=pad(d.getDate()), yy=d.getFullYear();
  const hh=pad(d.getHours()), mn=pad(d.getMinutes()), sc=pad(d.getSeconds());
  return `${mm}/${dd}/${yy} ${hh}:${mn}:${sc}`;
}

/** 
 * Return "H:MM:SS" difference between two Date objects
 */
function computeCumulativeTime(st, sp){
  if(!st||!sp)return"";
  const diff=sp-st, sec=Math.floor(diff/1000);
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  const pad=n=>(n<10?"0"+n:""+n);
  return `${h}:${pad(m)}:${pad(s)}`;
}

/** 
 * Insert row(s) into "Task Data" or "Task History" 
 * We do a POST with { values: [ [ ... ] ] }
 */
async function insertRow(url, rowArr){
  const resp = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ values: rowArr })
  });
  if(!resp.ok){
    const txt=await resp.text();
    throw new Error(`${resp.status} => ${txt}`);
  }
  return resp.json();
}

/** 
 * For partial updates to the "Backend" tab:
 *   /updateBackendCell => { rowNumber, columnLetter, newValue }
 */
async function updateBackendCell(rowNumber, columnLetter, newValue){
  const bodyObj={ rowNumber, columnLetter, newValue };
  const resp=await fetch(UPDATE_BACKEND_CELL_URL, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(bodyObj)
  });
  if(!resp.ok){
    const txt=await resp.text();
    throw new Error(`${resp.status} => ${txt}`);
  }
  return resp.json(); // typically { updatedRange:..., updatedRows:1, ... }
}


/******************************************************************************
 * 3) FIND DIRECT QUESTION
 ******************************************************************************
 * We'll read "questionAssociates" to see who to direct Qs to. 
 *****************************************************************************/
async function findDirectQuestion(clientName){
  if(!clientName)return"";
  try {
    const r=await fetch(QUESTION_ASSOC_URL);
    const j=await r.json();
    if(!j.values || !Array.isArray(j.values))return"";
    const headers=j.values[0]||[];
    const dataRows=j.values.slice(1);
    const cIdx=headers.indexOf("Client");
    const pIdx=headers.indexOf("Primary Contact");
    const sIdx=headers.indexOf("Secondary Contact");
    const bIdx=headers.indexOf("Backup Contact");
    if(cIdx<0)return"";

    const row=dataRows.find(rr=>(rr[cIdx]||"").trim().toLowerCase()===clientName.toLowerCase());
    if(!row)return"";
    return row[pIdx]||row[sIdx]||row[bIdx]||"";
  }catch(e){
    console.error("Error in findDirectQuestion =>", e);
    return"";
  }
}

/******************************************************************************
 * 4) RESET SCREEN
 ******************************************************************************
 * We hide #statusOptions, #notes, and unselect stopStatus radios,
 * plus clear the currentTask & rowNumber.
 *****************************************************************************/
function resetScreen(){
  document.getElementById("statusOptions").style.display="none";
  const noteEl=document.getElementById("notes");
  noteEl.value="";
  noteEl.style.display="none";

  document.querySelectorAll('input[name="stopStatus"]').forEach(r => r.checked=false);

  currentTask=null;
  currentRowNumber=null;
  startTime=null;
  document.getElementById("taskDetail").innerHTML="";
}

/** 
 * Called once a radio is chosen => we display #notes 
 */
function statusChosen(){
  document.getElementById("notes").style.display="block";
}


/******************************************************************************
 * 5) LOGIN
 ******************************************************************************
 * Hardcoded password => "abc123"
 * We fetch the "LaSalle Pod" to confirm user exists. 
 *****************************************************************************/
async function login(){
  setNotification("");
  const user=document.getElementById("username").value.trim().toLowerCase();
  const pass=document.getElementById("password").value.trim();
  highlightInput("username", !user);
  highlightInput("password", !pass);

  if(!user||!pass){
    setNotification("Username and Password are required.",true);
    return;
  }
  if(pass!==HARDCODED_PASS){
    setNotification("Invalid login credentials.",true);
    return;
  }
  const spin=document.getElementById("loginSpinner");
  spin.style.display="block";
  try{
    const r=await fetch(LASALLE_POD_URL);
    const j=await r.json();
    spin.style.display="none";

    if(!j.values||!Array.isArray(j.values)){
      setNotification("LaSalle Pod data not found or invalid structure.",true);
      return;
    }

    const headers=j.values[0]||[];
    const dataRows=j.values.slice(1);
    const uIdx=headers.indexOf("Username");
    const fnIdx=headers.indexOf("First Name");
    const lnIdx=headers.indexOf("Last Name");
    if(uIdx<0||fnIdx<0||lnIdx<0){
      setNotification("Missing columns in 'LaSalle Pod' tab",true);
      return;
    }

    const row=dataRows.find(rr=>(rr[uIdx]||"").trim().toLowerCase()===user);
    if(!row){
      setNotification("User not found in LaSalle Pod data.",true);
      return;
    }
    const fn=(row[fnIdx]||"").trim();
    const ln=(row[lnIdx]||"").trim();
    userFullName = fn+" "+ln;

    document.getElementById("greeting").textContent = "Hello, "+userFullName+"!";
    document.getElementById("loginOverlay").style.display="none";
    document.getElementById("taskScreen").style.display="block";
  }catch(e){
    spin.style.display="none";
    setNotification("Error => "+e.message,true);
  }
}


/******************************************************************************
 * 6) START TASK
 ******************************************************************************
 * Called when user clicks "Start Task"
 *  - We read "Backend" => find first row with (Associate=userFullName, Status=Ready)
 *  - partial update => Column B => Start Time, Column F => "Started"
 *  - insert row => 18 columns in Task Data + Task History
 *  - show #statusOptions
 *****************************************************************************/
function startTaskClicked(){
  setNotification("");
  document.getElementById("startTaskBtn").style.display="none";
  showLoading(true);
  loadReadyTask();
}

async function loadReadyTask(){
  try{
    const r=await fetch(BACKEND_URL);
    const j=await r.json();
    showLoading(false);

    if(!j.values){
      setNotification("Backend data missing 'values'.",true);
      resetScreen();
      document.getElementById("startTaskBtn").style.display="inline-block";
      return;
    }
    const headers=j.values[0]||[];
    const dataRows=j.values.slice(1);

    const assocIdx=headers.indexOf("Associate:");
    const statIdx =headers.indexOf("Status:");
    if(assocIdx<0||statIdx<0){
      setNotification("Missing 'Associate:' or 'Status:' columns in Backend",true);
      resetScreen();
      document.getElementById("startTaskBtn").style.display="inline-block";
      return;
    }

    let foundRow=null;
    let rowNum=null;
    for(let i=0; i<dataRows.length; i++){
      const rowArr=dataRows[i];
      const assoc=(rowArr[assocIdx]||"").trim().toLowerCase();
      const st=(rowArr[statIdx]||"").trim().toLowerCase();
      if(assoc===userFullName.toLowerCase() && st==="ready"){
        rowNum = i+2; 
        foundRow=rowArr;
        break;
      }
    }
    if(!foundRow){
      setNotification("You are on call. No tasks found for you.",true);
      document.getElementById("startTaskBtn").style.display="inline-block";
      document.getElementById("startTaskBtn").innerText="Refresh";
      document.getElementById("onCallModal").style.display="block";
      resetScreen();
      return;
    }

    // we have a "Ready" row
    currentRowNumber = rowNum;
    currentTask = convertRowToObj(foundRow, headers);
    startTime = new Date();

    // partial updates to "Backend" columns:
    // B => Start Time
    // F => "Started"
    await updateBackendCell(currentRowNumber, COL_START_TIME, formatDateTime(startTime));
    await updateBackendCell(currentRowNumber, COL_STATUS, "Started");

    // Also insert row => "Started" into Task Data + Task History
    const startStr=formatDateTime(startTime);

    // 18 columns
    // 0) Update:
    // 1) Start Time:
    // 2) Stop Time:
    // 3) Priority:
    // 4) Associate:
    // 5) Status:
    // 6) Client:
    // 7) Task:
    // 8) Deliverable Name:
    // 9) Deliverable ID:
    // 10) Param1
    // 11) Param2
    // 12) Production Notes
    // 13) Due Time
    // 14) Due Date
    // 15) Associate Notes
    // 16) Job Code
    // 17) Cumulative Time
    const row18 = [
      "FALSE",
      startStr,
      "",
      "",
      userFullName,
      "Started",
      currentTask["Client:"],
      currentTask["Task:"],
      currentTask["Deliverable Name:"],
      currentTask["Deliverable ID:"],
      currentTask["Parameter 1:"],
      currentTask["Parameter 2:"],
      currentTask["Production Notes:"],
      currentTask["Due Time:"],
      currentTask["Due Date:"],
      "",
      currentTask["Job Code:"],
      ""
    ];
    await insertRow(TASK_DATA_URL,    [row18]);
    await insertRow(TASK_HISTORY_URL, [row18]);

    // now display details
    document.getElementById("startTaskBtn").style.display="none";
    document.getElementById("onCallModal").style.display="none";

    await displayTaskDetails(currentTask);
    document.getElementById("statusOptions").style.display="block";

  }catch(e){
    showLoading(false);
    document.getElementById("startTaskBtn").style.display="inline-block";
    setNotification("Error => "+e.message,true);
  }
}

async function displayTaskDetails(task){
  if(!task){
    document.getElementById("taskDetail").innerHTML="<p>No tasks to display.</p>";
    return;
  }
  const qAssoc=await findDirectQuestion((task["Client:"]||"").trim());
  const html=`
    <div class="details-grid">
      <div><b>Client:</b> ${(task["Client:"]||"")}</div>
      <div><b>Parameter 1:</b> ${(task["Parameter 1:"]||"")}</div>
      <div><b>Task:</b> ${(task["Task:"]||"")}</div>
      <div><b>Parameter 2:</b> ${(task["Parameter 2:"]||"")}</div>
      <div><b>Deliverable Name:</b> ${(task["Deliverable Name:"]||"")}</div>
      <div><b>Production Notes:</b> ${(task["Production Notes:"]||"")}</div>
      <div><b>Direct Questions To:</b> ${qAssoc||""}</div>
      <div><b>Due Time:</b> ${(task["Due Time:"]||"")}</div>
    </div>
  `;
  document.getElementById("taskDetail").innerHTML=html;
}


/******************************************************************************
 * 7) STOP TASK
 ******************************************************************************
 * Called when user clicks "Stop Task":
 *  partial updates in "Backend" for columns:
 *   - C => Stop Time
 *   - F => final status
 *   - P => Associate Notes
 * plus inserting a row in Task Data/History with 18 columns, including 
 * "Stop Time:" and "Associate Notes:" and the computed "Cumulative Time:".
 *****************************************************************************/
async function stopTask(){
  setNotification("");
  document.getElementById("stopSpinner").style.display="block";
  document.querySelector(".stop-btn").style.display="none";
  showLoading(true);

  if(!currentTask){
    setNotification("No current task to stop.",true);
    endStopSpinner();
    return;
  }

  // which radio?
  let chosen="";
  const rads=document.getElementsByName("stopStatus");
  for(let i=0;i<rads.length;i++){
    if(rads[i].checked){
      chosen=rads[i].value;
      break;
    }
  }
  if(!chosen){
    setNotification("Please select a status first.",true);
    endStopSpinner();
    return;
  }
  // if "In Progress" or "Issue", notes required
  const noteVal=document.getElementById("notes").value.trim();
  const requiresNote=(chosen==="In Progress"||chosen==="Issue");
  highlightInput("notes", requiresNote && !noteVal);
  if(requiresNote && !noteVal){
    setNotification(`Notes are required for status: ${chosen}`,true);
    endStopSpinner();
    return;
  }

  try{
    const stopNow = new Date();
    const stopStr = formatDateTime(stopNow);
    const cTime   = computeCumulativeTime(startTime, stopNow);

    // partial updates to "Backend"
    // column C => Stop Time
    // column F => chosen status
    // column P => notes
    if(currentRowNumber){
      await updateBackendCell(currentRowNumber, COL_STOP_TIME, stopStr);
      await updateBackendCell(currentRowNumber, COL_STATUS, chosen);
      await updateBackendCell(currentRowNumber, COL_NOTES, noteVal);
    }

    // also insert row => 18 columns to Task Data + Task History
    const row18=[
      "FALSE",
      formatDateTime(startTime)||"",
      stopStr,
      "",
      userFullName,
      chosen,
      currentTask["Client:"],
      currentTask["Task:"],
      currentTask["Deliverable Name:"],
      currentTask["Deliverable ID:"],
      currentTask["Parameter 1:"],
      currentTask["Parameter 2:"],
      currentTask["Production Notes:"],
      currentTask["Due Time:"],
      currentTask["Due Date:"],
      noteVal,
      currentTask["Job Code:"],
      cTime
    ];
    await insertRow(TASK_DATA_URL, [row18]);
    await insertRow(TASK_HISTORY_URL, [row18]);

  }catch(e){
    setNotification("Error stopping task => "+e.message,true);
  }finally{
    resetScreen();
    endStopSpinner();

    document.getElementById("startTaskBtn").style.display="inline-block";
    document.getElementById("startTaskBtn").innerText="Start Task";
  }
}

function endStopSpinner(){
  document.getElementById("stopSpinner").style.display="none";
  document.querySelector(".stop-btn").style.display="inline-block";
  showLoading(false);
}


/******************************************************************************
 * 8) ON CALL / LOGOUT
 ******************************************************************************
 * If no tasks => On Call modal. Then they can Refresh or close game.
 *****************************************************************************/
function closeOnCall(){
  document.getElementById("onCallModal").style.display="none";
  resetScreen();
}

/** 
 * logout => reset screen, hide #taskScreen, show #loginOverlay
 */
function logout(){
  setNotification("");
  resetScreen();
  userFullName="";
  document.getElementById("taskScreen").style.display="none";
  document.getElementById("loginOverlay").style.display="flex";
  document.getElementById("username").value="";
  document.getElementById("password").value="";
}


/******************************************************************************
 * ~END~
 * This file is intentionally verbose (~800 lines) to incorporate every detail 
 * from the conversation. Replace the domain references with your Worker domain.
 * 
 *****************************************************************************/
</script>
</body>
</html>
